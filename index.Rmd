---
title: "The Promise and Perils of Packaging Your Processes"
subtitle: "(mostly promise)"
author: "Karl Hailperin"
date: "2016/12/12 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---
# Who am I?
```{r setup, include = FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

- Data science consultant
- Have built R packages for a client to streamline data processing and 
visualization
- They/them pronouns

---
# What this talk is (and isn't) about
- Not (necessarily) about destined for Github/CRAN
- Not about how to build packages/intro to `devtools` and `roxygen2` (but there 
will be resources on that at the end)
- It's about practices I've found useful in developing packages for personal use 
or at work.

---
# Why should I bother building a package if no one else is going to use it?
- `devtools` and `usethis` provide tools for documenting what you were 
thinking when you wrote the code and what your dependencies are
- `testthat` makes it easier to build unit tests that will keep you from 
breaking things (or at least not noticing that you're breaking things)
- Future you will be grateful
- Low-stress way to develop related skills
- Good rule of thumb (that I can't find the source for): If you re-use the same 
code three times, write a function. If you re-use the same function three times,
write a package.

---
# How repeated code is like for loops (and therefore cupcakes)
- [For those unfamiliar with the above reference](https://www.youtube.com/watch?v=GyNqlOjhPCQ)
- Repeating code obscures changes.
- Repeating code leads to accidental changes.
- Need to remember to manually propagate changes to all versions.

---
# utils.R is your friend (internal functions)
- Remember that not everything needs to be `@exported`-ed
- moving chunks of code into a (well-named) internal function can make it easier
to review and test your code
- "Rule of three" applies to code within functions
- makes it easy to update a common workflow or use a parameter to 'switch' 
which workflow your using

---
# Using sensible defaults
- Use defaults to hide repeated processes that you don't always want to run.
- For me, this was driven home by a _very_ slow processing step I almost never 
used.
- often a simple TRUE/FALSE parameter is enough

---
# Case study in internal functions and defaults
- Starting point was something like this:
```{r basic_pseudo_code}
# assorted documentation ommitted
# usethis::use_pipe() allows us to use %>% 
#' @export
read_page_views <- function(){
  here::here("data", "page_views.csv") %>% 
  readr::read_csv() %>% 
  # data comes in as UTC
  dplyr::mutate(time = lubridate::with_tz(time, tz = "America/Chicago"),
                # some non-standard characters in page names were coming out
                # garbled, and needed to be replaced for use in plot labels
                page_name = regex_stuff_to_handle_special_chars(page_name))
}
```

---
# But then we added bunch of other data sources...
- Also, there's discussion of reading directly from AWS.
- Now code looks more like `here::here("data", "web_data","page_views.csv")`.
- So now `read_page_views()` looks more like this:
```{r read_data_file}
#' @export
read_page_views <- function(){
  read_data_file(location = "web_data",
                 file_name = "page_views.csv") %>% 
  # data comes in as UTC
  dplyr::mutate(time = lubridate::with_tz(time, tz = "America/Chicago"),
                # some non-standard characters in page names were coming out
                # garbled, and needed to be replaced for use in plot labels
                page_name = regex_stuff_to_handle_special_chars(page_name))
}
```

- `read_data_file` is an internal function that wraps the first two steps

---
# That seems overly complicated...
- That's not entirely unfair.
- I may have omitted some code.


---
# Additional resources
- [RStudio's cheetsheet](https://github.com/rstudio/cheatsheets/blob/master/package-development.pdf)
- [_R Packages_ by Hadley Wickham](http://r-pkgs.had.co.nz/)
- [WIP 2<sup>nd</sup> edition with Jenny Bryan](https://r-pkgs.org/)
- ["Writing an R package from scratch" by Hilary 
Parker](https://hilaryparker.com/2014/04/29/writing-an-r-package-from-scratch/)
- [Thomas Westlake's version of "Writing an R package from scratch" using 
`usethis`](https://r-mageddon.netlify.com/post/writing-an-r-package-from-scratch/)
- ["R Package Primer" by Karl Broman](https://kbroman.org/pkg_primer/)
- ["`usethis` workflow for package development" by Emil 
Hvitfedlt](https://www.hvitfeldt.me/blog/usethis-workflow-for-package-development/)
- [The tidyverse style guide](https://style.tidyverse.org/)

---
# Thank you/questions
